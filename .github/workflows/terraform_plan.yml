name: 'Terraform deploy'
on: [workflow_dispatch]
permissions:
  contents: read
  id-token: write  
jobs:
  google-cloud:
    name: 'Google Cloud auth'
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: "Terraform:\n  - 'terraform/**'     \n"
      - name: 'Google Cloud auth'
        uses: 'google-github-actions/auth@v2'
        with:
          project_id: '${{ secrets.TESTING_PROJECT }}'
          workload_identity_provider: '${{ secrets.WIF_PROVIDER }}'
          service_account: '${{ secrets.WIF_SERVICE_ACCOUNT }}'
  terraform:
    name: 'Terraform'
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: "Terraform:\n  - 'terraform/**'     \n"
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
      - name: Terraform Init
        working-directory: terraform
        run: |
          ls -d */ | while read d
          do
          echo "Running tf init in directory: $d"
          cd $d && terraform init && cd ..
          done
      - name: Terraform Plan
        working-directory: terraform
        run: |
          ls -d */ | while read d
          do
          echo "Running tf format check in directory: $d"
          cd $d
          echo project_create = false > terraform.tfvars
          echo project_id = ${{ secrets.TESTING_PROJECT }} >> terraform.tfvars
          echo region = us-central-1 >> terraform.tfvars
          terraform plan
          cd ..
          done
